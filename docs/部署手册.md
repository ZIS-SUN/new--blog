# 个人博客系统 - 部署手册

## 目录
1. [环境准备](#环境准备)
2. [数据库部署](#数据库部署)
3. [后端部署](#后端部署)
4. [前端部署](#前端部署)
5. [Nginx 配置](#nginx-配置)
6. [常见问题](#常见问题)

---

## 环境准备

### 系统要求
- **操作系统**: Linux / macOS / Windows
- **JDK**: 17 或更高版本
- **Node.js**: 16.0 或更高版本
- **MySQL**: 8.0 或更高版本
- **Maven**: 3.6 或更高版本
- **Nginx**: 1.18 或更高版本（生产环境）

### 检查环境

```bash
# 检查 Java 版本
java -version

# 检查 Node.js 版本
node -v

# 检查 MySQL 版本
mysql --version

# 检查 Maven 版本
mvn -version
```

---

## 数据库部署

### 1. 创建数据库

登录 MySQL：
```bash
mysql -u root -p
```

导入数据库脚本：
```bash
mysql -u root -p < database/blog_schema.sql
```

或者在 MySQL 客户端中执行：
```sql
source /path/to/blog/database/blog_schema.sql;
```

### 2. 验证数据库

```sql
USE personal_blog;
SHOW TABLES;
```

应该看到 11 个表：
- user
- article
- category
- tag
- article_tag
- comment
- message
- announcement
- log
- visit_log
- system_config

### 3. 默认数据

系统已自动创建：
- 管理员账户: `admin` / `admin123`
- 3个示例分类
- 6个示例标签
- 1条欢迎公告

---

## 后端部署

### 1. 配置文件

编辑 `backend/src/main/resources/application.yml`：

```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/personal_blog?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
    username: root        # 修改为你的数据库用户名
    password: your_password  # 修改为你的数据库密码

# JWT 密钥（生产环境建议修改）
jwt:
  secret: your-secret-key-change-in-production
  expiration: 86400000

# 文件上传路径（根据实际情况修改）
file:
  upload-path: /var/blog/uploads/
```

### 2. 开发环境启动

```bash
cd backend
mvn clean install
mvn spring-boot:run
```

访问: http://localhost:8080/api/swagger-ui.html 查看 API 文档

### 3. 生产环境部署

**打包应用：**
```bash
mvn clean package -DskipTests
```

生成的 JAR 文件位于 `target/personal-blog-1.0.0.jar`

**运行应用：**
```bash
# 前台运行
java -jar target/personal-blog-1.0.0.jar

# 后台运行
nohup java -jar target/personal-blog-1.0.0.jar > blog.log 2>&1 &
```

**使用外部配置：**
```bash
java -jar personal-blog-1.0.0.jar --spring.config.location=/path/to/application.yml
```

**指定端口：**
```bash
java -jar personal-blog-1.0.0.jar --server.port=8081
```

### 4. 使用 Systemd（推荐）

创建服务文件 `/etc/systemd/system/blog-backend.service`：

```ini
[Unit]
Description=Personal Blog Backend
After=syslog.target network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/var/blog/backend
ExecStart=/usr/bin/java -jar /var/blog/backend/personal-blog-1.0.0.jar
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启动服务：
```bash
sudo systemctl daemon-reload
sudo systemctl start blog-backend
sudo systemctl enable blog-backend
sudo systemctl status blog-backend
```

---

## 前端部署

### 1. 安装依赖

```bash
cd frontend
npm install
```

### 2. 开发环境启动

```bash
npm run dev
```

访问: http://localhost:3000

### 3. 生产环境构建

**修改 API 地址（如果需要）：**

编辑 `frontend/vite.config.js`：
```javascript
export default defineConfig({
  server: {
    proxy: {
      '/api': {
        target: 'http://your-backend-domain.com',  // 修改为实际后端地址
        changeOrigin: true
      }
    }
  }
})
```

**构建生产版本：**
```bash
npm run build
```

构建产物位于 `dist/` 目录

### 4. 部署到服务器

**方式一：上传到 Nginx**
```bash
# 压缩构建产物
tar -czf dist.tar.gz dist/

# 上传到服务器
scp dist.tar.gz user@server:/var/www/blog/

# 在服务器上解压
ssh user@server
cd /var/www/blog/
tar -xzf dist.tar.gz
```

**方式二：使用 rsync**
```bash
rsync -avz --delete dist/ user@server:/var/www/blog/
```

---

## Nginx 配置

### 1. 基础配置

创建配置文件 `/etc/nginx/sites-available/blog`：

```nginx
server {
    listen 80;
    server_name your-domain.com;  # 修改为你的域名
    
    # 前端静态文件
    location / {
        root /var/www/blog/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
    
    # 后端 API 代理
    location /api/ {
        proxy_pass http://localhost:8080/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # 文件上传
    location /uploads/ {
        alias /var/blog/uploads/;
        autoindex off;
    }
    
    # Gzip 压缩
    gzip on;
    gzip_vary on;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss;
}
```

### 2. HTTPS 配置（推荐）

使用 Let's Encrypt 申请免费证书：

```bash
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com
```

Nginx 会自动配置 HTTPS

### 3. 启用配置

```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/blog /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx
```

---

## 常见问题

### 1. 后端无法连接数据库

**问题**: `Communications link failure`

**解决**:
- 检查 MySQL 是否启动: `sudo systemctl status mysql`
- 检查数据库配置是否正确
- 检查防火墙是否阻止 3306 端口

### 2. 跨域问题

**问题**: CORS 错误

**解决**: 后端已配置跨域支持，检查 `WebConfig.java` 中的配置

### 3. 文件上传失败

**问题**: 上传文件提示失败

**解决**:
- 检查上传目录是否存在并有写权限
- 检查文件大小限制配置
```bash
sudo mkdir -p /var/blog/uploads
sudo chown -R www-data:www-data /var/blog/uploads
```

### 4. 前端白屏

**问题**: 访问前端显示空白

**解决**:
- 检查构建是否成功
- 检查 Nginx 配置中的 root 路径
- 查看浏览器控制台错误

### 5. JWT Token 过期

**问题**: 频繁要求重新登录

**解决**: 修改 `application.yml` 中的过期时间
```yaml
jwt:
  expiration: 86400000  # 24小时，单位：毫秒
```

### 6. 端口被占用

**问题**: `Port 8080 already in use`

**解决**:
```bash
# 查找占用端口的进程
lsof -i :8080

# 杀死进程
kill -9 <PID>

# 或者修改应用端口
java -jar app.jar --server.port=8081
```

---

## 性能优化建议

### 1. 数据库优化
- 定期备份数据库
- 为常用查询字段添加索引
- 配置连接池大小

### 2. 后端优化
- 启用 Redis 缓存（可选）
- 配置 JVM 参数
```bash
java -Xms512m -Xmx1024m -jar app.jar
```

### 3. 前端优化
- 启用 Nginx Gzip 压缩
- 配置静态资源缓存
- 使用 CDN（可选）

### 4. 监控
- 配置日志记录
- 监控服务器资源使用
- 定期检查系统日志

---

## 安全建议

1. **修改默认密码**: 登录后立即修改管理员密码
2. **JWT 密钥**: 生产环境使用强密码
3. **HTTPS**: 强烈建议启用 HTTPS
4. **防火墙**: 只开放必要的端口（80, 443）
5. **定期更新**: 保持系统和依赖包更新
6. **备份**: 定期备份数据库和文件

---

## 日志位置

- **后端日志**: `blog.log` 或控制台输出
- **Nginx 访问日志**: `/var/log/nginx/access.log`
- **Nginx 错误日志**: `/var/log/nginx/error.log`
- **MySQL 日志**: `/var/log/mysql/error.log`

---

## 技术支持

如有问题，请查看：
- 项目 README.md
- API 文档: http://localhost:8080/api/swagger-ui.html
- 系统日志文件

---

**部署完成后，访问您的域名即可使用博客系统！**


